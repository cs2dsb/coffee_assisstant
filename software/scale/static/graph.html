<!DOCTYPE HTML>
<html style="height: 100%">
<head>
    <meta charset="utf-8" />
    <title>Time against Weight </title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body style="height: 100%">
    <div id="graph" style="height: 80%"></div>
    <div id="weight" style="height: 10%"></div>
    <div id="cal_status"></div>
    <div>
        <button id="tare">Tare</button>
        <button id="calibrate">Calibrate</button>
    </div>

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/boost.js"></script>
    <script src="https://code.highcharts.com/modules/series-label.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/reconnecting-websocket/1.0.0/reconnecting-websocket.min.js" integrity="sha512-B4skI5FiLurS86aioJx9VfozI1wjqrn6aTdJH+YQUmCZum/ZibPBTX55k5d9XM6EsKePDInkLVrN7vPmJxc1qA==" crossorigin="anonymous"></script>

    <script src="/js/events.js"></script>
    <script src="/js/ws.js"></script>

    <script type="text/javascript">
        const chart = Highcharts.chart('graph', {
            boost: { useGPUTranslations: true, usePreAllocated: true },
            chart: { animation: false },
            title: { text: 'Time against Weight' },
            yAxis: { title: { text: 'Weight (g)' }},
            xAxis: { title: { text: 'Time (seconds)' }},
            plotOptions: { series: { label: { connectorAllowed: false }}},
            series: [{ name: 'Weight', data: [] }],
        });

        const set_status = (status) => weight.innerHTML = status;
        const clear_chart = () => chart.series[0].setData([]);

        window.events.on("websocket_json", (json) => {
            if (json.time != undefined && json.weight != undefined) {
                chart.series[0].addPoint([json.time, json.weight]);
                set_status(` ${json.weight}g in ${json.time} seconds `);
            } else if (json.tare != undefined) {
                clear_chart();
                set_status("Tared");
            } else if (json.calibration_value != undefined) {
                clear_chart();
                cal_status.innerHTML = `Calibration value: ${ json.calibration_value }`;
            } else {
                console.log("Unhandled message:", json);
            }
        });

        tare.onclick = () => window.events.emit("websocket_send", "tare");
        calibrate.onclick = () => window.events.emit("websocket_send", "calibrate");

    </script>
</body>
</html>




